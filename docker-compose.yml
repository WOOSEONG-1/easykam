services:
  redis:
    image: redis:7.2-alpine
    container_name: easykam-redis
    env_file:
      - .env
    command: >
      sh -lc '
        test -n "$REDIS_PASSWORD" || { echo "REDIS_PASSWORD missing"; exit 1; }
        exec redis-server --appendonly yes --save 60 1000
          --requirepass "$REDIS_PASSWORD"           
          --maxmemory-policy allkeys-lru
      '
    ports:
      - "0.0.0.0:6379:6379"      # 로컬만 허용 (필요 시 0.0.0.0으로)
    environment:
      - TZ=Asia/Seoul
    volumes:
      - redis_data:/data
    restart: always
    
  api:
    container_name: easykam-api
    build:
      context: ./fastapi          # ✅ 루트(.) 말고 fastapi 폴더를 컨텍스트로
      dockerfile: Dockerfile
    restart: always
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - TZ=Asia/Seoul
    env_file:
      - .env

  web:
    container_name: easykam-web
    build:
      context: ./front/easykam
      dockerfile: Dockerfile
    restart: always
    ports:
      - "127.0.0.1:8081:80"
    environment:
      - TZ=Asia/Seoul
    depends_on:
      - api

volumes:
  redis_data: {}